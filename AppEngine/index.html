<!doctype html>
<html>

<head>
    <title>Snibble</title>

    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">

    <!-- 1. Load platform.js for polyfill support. -->
    <script src="bower_components/platform/platform.js"></script>
    <!-- 2. Use an HTML Import to bring in the element. -->
    <link rel="import" href="bower_components/core-ajax/core-ajax.html">

    <!-- RTCMultiConnection script -->
    <script type="text/javascript" src="js/RTCMultiConnection.js"></script>
    <!-- Firebase script -->
    <script type="text/javascript" src="https://cdn.firebase.com/js/client/1.0.15/firebase.js"></script>
    <!-- jQuery stuff -->
    <script type="text/javascript" src="js/jquery-ui-1.11.0/external/jquery/jquery.js"></script>
    <script type="text/javascript" src="js/jquery-ui-1.11.0/jquery-ui.min.js"></script>
    <script type="text/javascript" src="js/colResizeable/colResizable-1.3.min.js"></script>

    <!-- Polymer HTML imports -->
    <link rel="import" href="bower_components/core-drawer-panel/core-drawer-panel.html">
    <link rel="import" href="bower_components/core-icon-button/core-icon-button.html">
    <link rel="import" href="bower_components/core-toolbar/core-toolbar.html">
    <link rel="import" href="bower_components/core-pages/core-pages.html">
    <link rel="import" href="bower_components/paper-tabs/paper-tab.html">
    <link rel="import" href="bower_components/paper-tabs/paper-tabs.html">
    <link rel="import" href="bower_components/paper-input/paper-input.html">
    <link rel="import" href="bower_components/paper-button/paper-button.html">
    <link rel="import" href="bower_components/paper-shadow/paper-shadow.html">
    <link rel="import" href="bower_components/paper-toast/paper-toast.html">
    <link rel="import" href="bower_components/core-list/core-list.html">

    <style src="css/main.css"></style>
    <style>
        :host {
            position: absolute;
            width: 100%;
            height: 100%;
            box-sizing: border-box;
        }
        #core_drawer_panel {
            position: absolute;
        }
        #section1 {
            box-shadow: rgba(0, 0, 0, 0.0980392) 0px 2px 4px, rgba(0, 0, 0, 0.0980392) 0px 0px 3px;
            background-color: rgb(250, 250, 250);
        }
        #section2 {
            height: 100%;
            box-sizing: border-box;
            background-color: rgb(221, 221, 221);
        }
        #core_toolbar,
        #core_toolbar_settings,
        #core_toolbar_chat {
            color: rgb(255, 255, 255);
            fill: rgb(255, 255, 255);
            background-color: rgb(79, 125, 201);
        }
        #paper_tabs {
            color: rgb(255, 255, 255);
            box-shadow: rgba(0, 0, 0, 0.2) 0px 3px 2px;
            background-color: rgb(79, 125, 201);
        }
        .card {
            background: white;
            height: 60px;
            width: 100%;
            position: absolute;
            bottom: 20px
        }
        #chat-output {
            background: white;
            height: 80px;
            width: 100%;
            position: absolute;
            bottom: 85px;
            overflow-y: auto;
        }
        #chat-input {
            width: 100%;
            height: 40px;
        }
        #content {
            height: inherit;
            background: #eee;
        }
        #contentPage {
            height: inherit;
        }
        #media {
            height: 70%;
            width: 100%;
            overflow-y: auto;
        }
    </style>

</head>

<body unresolved>
    <core-drawer-panel id="core_drawer_panel">
        <section id="section1" drawer>
            <core-toolbar id="core_toolbar">
                <div id="div" flex>Snibble</div>
            </core-toolbar>
            <paper-tabs selected="0" id="paper_tabs">
                <paper-tab id="paper_tab1" active>
                    <core-item icon="mail" label="Chat"></core-item>Chat</paper-tab>
                <paper-tab id="paper_tab2">
                    <core-item icon="settings" label="Settings"></core-item>Settings</paper-tab>
            </paper-tabs>
            <core-pages selected="0" id="contentSelectorPage">
                <div>
                    <core-list id="contact-list" data="{{data}}">
                        <template>
                            <div id="contact-item">{{userid}}</div>
                        </template>
                    </core-list>
                </div>
                <div>Settings</div>
            </core-pages>
        </section>
        <section id="section2" main>
            <core-pages selected="0" id="contentPage">
                <div id="content">
                    <core-toolbar id="core_toolbar_chat">
                        <div id="chat-toolbar-text" flex>UserID: </div>
                    </core-toolbar>
                    <paper-input id="userID-input" label="UserID"></paper-input>
                    <paper-button label="Connect to user" raisedButton on-click="clickHandler" id="connectToUser"></paper-button>
                    <paper-button label="Audio" on-click="clickHandler" id="streamAudio"></paper-button>
                    <paper-button label="Video" on-click="clickHandler" id="streamVideoAudio"></paper-button>
                    <div id="media">
                        <table id="mediaTable" width="100%">
                            <tr>
                                <th>Local media</th>
                                <th>Remote media</th>
                            </tr>
                            <tr>
                                <td></td>
                                <td></td>
                            </tr>
                        </table>
                    </div>
                    <paper-toast id="toasty" text="" duration="3000"></paper-toast>
                    <div id="chat-output"></div>
                    <div class="card">
                        <paper-input id="chat-input" label="Chat message"></paper-input>
                    </div>
                </div>
                <div id="settings-page">
                    <core-toolbar id="core_toolbar_settings">
                        <div id="div1" flex></div>
                    </core-toolbar>
                    Settings to be added here...
                </div>
            </core-pages>
        </section>
    </core-drawer-panel>

    <script>
        // Grab the tabs element
        var tabs = document.querySelector('paper-tabs');
         // Handle the clicks on the tabs
        tabs.addEventListener('core-select', function () {
            var contentSelectorPage = document.getElementById('contentSelectorPage');
            var contentPage = document.getElementById('contentPage');

            contentSelectorPage.selected = tabs.selected;
            contentPage.selected = tabs.selected;
        });

        // Variable for who the current user has selected
        var currentlySelected = "";

        // Grab the contact-list DOM element
        var contactList = document.getElementById("contact-list");
        // Create the item click listener
        contactList.addEventListener('core-activate', function (listItem) {
            // Populate the chat area with correct user information
            currentlySelected = listItem.detail.item.textContent;
            console.log(currentlySelected);
        });


        // Function for generating new userIDs
        function GenerateUserID() {
            var text = "";
            var charSet = "ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789";

            for (var i = 0; i < 24; i++)
                text += charSet.charAt(Math.floor(Math.random() * charSet.length));

            return text;
        } // end GenerateUserID()

        // Function for creating new connections
        function CreateNewConnection(currentUserID, connectingToUserID) {
            var newConnection = new RTCMultiConnection(connectingToUserID);

            // Set the current user's userID to their unique userID
            newConnection.userid = currentUserID;

            // Create the list for public STUN servers
            var iceServers = [{
                    url: 'stun:stun.l.google.com:19302'
                              },
                {
                    url: 'stun:stun1.l.google.com:19302'
                              },
                {
                    url: 'stun:stun2.l.google.com:19302'
                              },
                {
                    url: 'stun:stun3.l.google.com:19302'
                              },
                {
                    url: 'stun:stun4.l.google.com:19302'
                              }];
            // Set STUN servers!
            newConnection.iceServers = iceServers;

            // Set which kind of media you want to share over the session
            newConnection.session = {
                data: true
            };

            // When the new connection opens
            newConnection.onopen = function(e) {
                // e.userid
                // e.extra
                // Set the currentlySelected user to the newly connected one
                currentlySelected = e.userid;

                // Create custom message event
                newConnection.peers[e.userid].onCustomMessage = function(message) {
                    if (message.type == "textChat") {
                        AddToChatLog(message.from, message.to, message.message);
                        // Still need to update the UI accordingly

                    } else {
                        var toast = document.querySelector('#toasty');
                        toast.text = "YO NIGGA YOU GOT A CUSTOM MESSAGE " + message;
                        toast.show();
                        console.log(message);
                    } // end if/else
                };

                // Show a toast message for connecting to a user
                console.log("Connected to: " + e.userid);
                var toast = document.querySelector('#toasty');
                toast.text = "Connected to " + e.userid + "! :)";
                toast.show();

                // Add the newly connected user to current user's connection history!
                if (userConnectionHistory == null) {
                    userConnectionHistory = [{userid: e.userid}];
                    localStorage.setItem("userConnectionHistory", JSON.stringify(userConnectionHistory));

                    // Set the now not null connection history
                    contactList.data = userConnectionHistory;
                } else {
                    if (userConnectionHistory.indexOf(e.userid) == -1) {
                        userConnectionHistory.unshift({userid: e.userid});
                        localStorage.setItem("userConnectionHistory", JSON.stringify(userConnectionHistory));
                        console.log("Added \'" + e.userid + "\' to the user connection history.");
                    } else {
                        console.log("\'" + e.userid + "\' was already in the user connection history.");
                    } // end if/else
                } // end if/else

                console.log(newConnection);
            } // end onopen()

            // On getting local or remote media stream
            newConnection.onstream = function (e) {
                var mediaDiv = document.getElementById('media');
                var tableObject = document.getElementById("mediaTable");
                var numOfRows = tableObject.rows.length;

                if (e.type == "local") {
                    var localMedia = e.mediaElement;
                    localMedia.setAttribute("id", "local-media");

                    var mediaRow = tableObject.rows[1];

                    var localMediaCell = mediaRow.cells[0];
                    localMediaCell.appendChild(localMedia);
                } else {
                    var remoteMedia = e.mediaElement;
                    remoteMedia.setAttribute("id", "remote-media");

                    if (numOfRows <= 2) {
                        var mediaRow = tableObject.rows[1];

                        var remoteMediaCell = mediaRow.cells[1];
                        remoteMediaCell.appendChild(remoteMedia);
                    } else {
                        var row = tableObject.insertRow(numOfRows);
                        var cell1 = row.insertCell(0);
                        var cell2 = row.insertCell(1);
                        cell2.appendChild(remoteMedia);
                    } // end if/else
                } // end if/else
            };

            //
            // Signalling stuff
            //
            var channels = {};
            var firebase = new Firebase('https://webrtcantiskype.firebaseio.com/blah');

            firebase.on('child_added', function(snap) {
                var data = snap.val();

                if (data.sender == newConnection.userid) return;

                if (channels[data.channel]) {
                    channels[data.channel](data.message);
                };

                snap.ref().remove();
            });

            // Overriding "openSignalingChannel" method
            newConnection.openSignalingChannel = function(config) {
                var channel = config.channel || this.channel;
                channels[channel] = config.onmessage;

                if (config.onopen) setTimeout(config.onopen, 1000);

                return {
                    send: function(message) {
                        firebase.push({
                            sender: newConnection.userid,
                            channel: channel,
                            message: message
                        });
                    },
                    channel: channel
                };
            };

            newConnection.onNewSession = function(session) {
                // session.userid
                // session.sessionid
                // session.extra
                // session.session i.e. {audio,video,screen,data}
                console.log("OnNewSession fired!");
                console.log(session);
                session.join();
            };

            //
            // Text chat stuff
            //
            // When a new message is received
            newConnection.onmessage = function (e) {
                console.log(e.userid + ": " + e.data);
                AddToChatLog(e.userid, currentUserID, e.data);

                var chatOutput = document.getElementById('chat-output');
                var div = document.createElement('div');
                div.innerHTML = '<div id="chat-text">' + e.userid + ": " + e.data + '</div>';
                chatOutput.appendChild(div);
            };
            // When sending a new message
            var chatInput = document.getElementById('chat-input');
            chatInput.onkeydown = function (e) {
                if (e.keyCode == 13 && this.inputValue.trim() != '') {
                    console.log("(Me)" + newConnection.userid + ": " + this.inputValue);

                    SendChatMessage(currentUserID, currentlySelected, this.inputValue);


                    newConnection.send(this.inputValue);

                    var chatOutput = document.getElementById('chat-output');
                    var div = document.createElement('div');
                    div.innerHTML = '<div id="chat-text">' + "Me: " + this.inputValue + '</div>';
                    chatOutput.appendChild(div);

                    this.inputValue = '';
                } // end if
            };

            return newConnection;
        } // end CreateNewConnection()

        function SendChatMessage(fromUserID, toUserID, messageToSend) {
            // If we're connected to the user we want to send the message to, send it!
            //   Else, connect to them, and then send the message!
            var isConnected = IsCurrentlyConnected(toUserID);
            if (isConnected.connected) {
                console.log("We're connected! Send the message!");
                currentUserConnections[isConnected.index]
                        .connectionObject.peers[toUserID].sendCustomMessage(
                            {"type": "textChat",
                             "from": fromUserID,
                             "to": toUserID,
                             "message": messageToSend});

            } else {
                console.log("Not connected, attempting connection now...");
                ConnectToUser(toUserID);

                // TODO: This is almost defintiely a bad workaround. Notify Jack and think of a better way
                var justMadeConLength = currentUserConnections.length - 1;
                currentUserConnections[justMadeConLength].connectionObject
                    .onstatechange = function (state, reason) {
                        if(state == 'connected-with-initiator') {
                            this.sendCustomMessage(
                                {"type":"textChat",
                                 "from": fromUserID,
                                 "to": toUserID,
                                 "message": messageToSend});
                        } // end if
                    };
            } // end if/else

            // Add the message to the user's chat log
            AddToChatLog(fromUserID, toUserID, messageToSend);

        } // end SendChatMessage()

        // Custom UserConnection object
        function UserConnection(currentUserID, connectionType, userIDToConnectTo, connectionObject) {
            // The userID for the current user in the connection
            this.currentUserID = currentUserID;
            // Whether the connection is 'local' or 'remote'
            this.connectionType = connectionType;
            // The userID for for the user is to connect to
            this.userIDToConnectTo = userIDToConnectTo;
            // The actual connection object
            this.connectionObject = connectionObject;
        } // end UserConnection()

        function IsCurrentlyConnected(userIDToConnectTo) {
            for (var i = 0; i < currentUserConnections.length; i++) {
                if (typeof currentUserConnections[i].connectionObject.peers[userIDToConnectTo] !== "undefined") {
                    return {"connected": true, "index": i};
                } // end if
            } // end for
            return {"connected": false, "index": -1};
        } // end IsCurrentlyConnected()

        function ConnectToUser(userIDToConnectTo) {
            // Check if we're already connected to the user we want to connect to
            if (!IsCurrentlyConnected(userIDToConnectTo).connected) {
                // Add a new connection onto the current user's connection array
                var newConIndex = currentUserConnections.length;
                console.log("New connection index: " + newConIndex);

                currentUserConnections[newConIndex] = new UserConnection();
                currentUserConnections[newConIndex].currentUserID = currentUserConnections[0].currentUserID;
                currentUserConnections[newConIndex].connectionType = "remote";
                currentUserConnections[newConIndex].userIDToConnectTo = userIDToConnectTo;
                currentUserConnections[newConIndex].connectionObject =
                    CreateNewConnection(currentUserConnections[newConIndex].currentUserID,
                                        currentUserConnections[newConIndex].userIDToConnectTo);

                currentUserConnections[newConIndex].connectionObject.connect(userIDToConnectTo);
                console.log(currentUserConnections);
            } else {
                var toast = document.querySelector('#toasty');
                toast.text = "Already connected!!";
                toast.show();
            } // end if/else
        } // end ConnectToUser()

        function AddToChatLog(fromUserID, toUserID, message) {
            // If userChatLog is null, just set its value to the new entry
            //   Else, try to find the userID and add the new message to the log
            if (userChatLog == null) {
                userChatLog = [{"userID": fromUserID,
                                "messages":
                                        [{"timestamp": GetDateTime(),
                                         "to": toUserID,
                                         "from": fromUserID,
                                         "message": message}]}];
            } else {
                // For all entries in userChatLog, try and find the given userID
                // If we found it, append the new message onto it and break
                for (var i = 0; i < userChatLog.length; i++) {
                    if (userChatLog[i].userID == fromUserID) {
                        userChatLog[i].messages.unshift({"timestamp": GetDateTime(),
                                                         "to": toUserID,
                                                         "from": fromUserID,
                                                         "message": message});
                        // Swap the current userID index with the first one to keep the log in chronological order
                        userChatLog[0] = userChatLog.splice(i, 1, userChatLog[0])[0];
                        break;
                    } // end if
                } // end for
                // We can't find the userID, so add the new user object with the message
                userChatLog.unshift({"userID": fromUserID,
                                     "messages":
                                            [{"timestamp": GetDateTime(),
                                            "to": toUserID,
                                            "from": fromUserID,
                                            "message": message}]});
            } // end if/else

            // Save the updated chatlog to the localStorage
            localStorage.setItem("userChatLog", JSON.stringify(userChatLog));
        } // end AddToChatLog()

        function GetDateTime() {
            var now     = new Date();
            var year    = now.getFullYear();
            var month   = now.getMonth()+1;
            var day     = now.getDate();
            var hour    = now.getHours();
            var minute  = now.getMinutes();
            var second  = now.getSeconds();
            if(month.toString().length == 1) {
                var month = '0'+month;
            }
            if(day.toString().length == 1) {
                var day = '0'+day;
            }
            if(hour.toString().length == 1) {
                var hour = '0'+hour;
            }
            if(minute.toString().length == 1) {
                var minute = '0'+minute;
            }
            if(second.toString().length == 1) {
                var second = '0'+second;
            }
            var dateTime = hour+':'+minute+':'+second+' '+month+'/'+day+'/'+year;
            return dateTime;
        } // end GetDateTime()




        //
        // Begin actually running
        //

        // Check for localstorage support!
        if (typeof (Storage) !== "undefined") {
            // Attempt to get the locally stored currentUserID
            var storedCurrentUserID = localStorage.getItem("currentUserID");
            // If storedCurrentUserID isn't null, set currentUserID to its value
            //   Else generate and store a currentUserID
            if (storedCurrentUserID !== null) {
                // Snag the currentUserID from the stored version
                var currentUserID = storedCurrentUserID;
                console.log("Current userID is: " + currentUserID);
            } else {
                // Generate the new userID
                var currentUserID = GenerateUserID();
                console.log("Current userID is: " + currentUserID);
                // Store the newly generated userID in localstorage
                localStorage.setItem("currentUserID", currentUserID);
            } // end if/else
            // Place the currentUserID into the title bar so the user knows who they are
            document.getElementById('chat-toolbar-text').innerHTML += currentUserID;


            // Attempt to get the locally stored userConnectionHistory
            var userConnectionHistory = localStorage.getItem("userConnectionHistory");
            // Check if userConnectionHistory is null, if not, then parse it!
            if (userConnectionHistory !== null) {
                userConnectionHistory = JSON.parse(userConnectionHistory);

                // Set contact list to the connection history
                contactList.data = userConnectionHistory;
            }// end if


            // Attempt to get the locally stored userChatLog
            var userChatLog = localStorage.getItem("userChatLog");
            // Check if userConnectionHistory is null, if not, then parse it!
            if (userChatLog !== null) {
                userChatLog = JSON.parse(userChatLog);
            }// end if

        } else {
            console.log("No localstorage support... :(");
        } // end if/else

        // Make an array for all of current user's connections
        var currentUserConnections = [];

        // Create the current user's home connection
        currentUserConnections[0] = new UserConnection();
        currentUserConnections[0].currentUserID = currentUserID;
        currentUserConnections[0].connectionType = "local";
        currentUserConnections[0].connectionUserID = currentUserID;
        currentUserConnections[0].connectionObject = CreateNewConnection(currentUserID, currentUserID);
        console.log(currentUserConnections);

        // Open the home connection
        currentUserConnections[0].connectionObject.open(currentUserID);
        console.log(currentUserConnections[0]);


         // Connect to another user!
        document.getElementById('connectToUser').onclick = function () {
            var userIDInput = document.getElementById('userID-input');
            var userIDToConnect = userIDInput.inputValue.trim();

            // If nothing is entered into the input box, do nothing
            if (userIDToConnect == "") {
                return;
            } // end if

            // Reset the input box to empty
            userIDInput.inputValue = "";

            console.log("Attempting to connect with " + userIDToConnect);
            ConnectToUser(userIDToConnect);
        };

        // THIS IS ALL PLACEHOLDER UNTIL CONTACT LIST IS WORKING
        document.getElementById('streamAudio').onclick = function () {
            try {
                currentUserConnections[0].connectionObject.addStream({
                    audio: true,
                    oneway: true
                });
            } catch (err) {
                currentUserConnections[1].connectionObject.addStream({
                    audio: true,
                    oneway: true
                });
            } // end try/catch
        };
        document.getElementById('streamVideoAudio').onclick = function () {
            try {
                currentUserConnections[0].connectionObject.addStream({
                    audio: true,
                    oneway: true
                });
            } catch (err) {
                currentUserConnections[1].connectionObject.addStream({
                    audio: true,
                    oneway: true
                });
            } // end try/catch
        };
    </script>

</body>

</html>
